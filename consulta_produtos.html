<!DOCTYPE html>
<html lang="en">
<style>
  /* Estilos para o popup */
  .popup {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    padding: 20px;
    background: #fff;
    border: 1px solid #ccc;
    box-shadow: 0px 0px 10px #999;
    z-index: 1000;
  }

  /* Estilos para o overlay de fundo */
  .overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 999;
  }

  /* Estilos para fechar o popup */
  .close {
    position: absolute;
    top: 10px;
    right: 10px;
    cursor: pointer;
  }
</style>

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Economizando!</title>
  <!-- Google Font: Source Sans Pro -->
  <link rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
  <!-- Ionicons -->
  <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
  <!-- Tempusdominus Bootstrap 4 -->
  <link rel="stylesheet" href="plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
  <!-- iCheck -->
  <link rel="stylesheet" href="plugins/icheck-bootstrap/icheck-bootstrap.min.css">
  <!-- JQVMap -->
  <link rel="stylesheet" href="plugins/jqvmap/jqvmap.min.css">
  <!-- Theme style -->
  <link rel="stylesheet" href="dist/css/adminlte.min.css">
  <!-- overlayScrollbars -->
  <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
  <!-- Daterange picker -->
  <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker.css">
  <!-- summernote -->
  <link rel="stylesheet" href="plugins/summernote/summernote-bs4.min.css">
</head>

<body class="hold-transition sidebar-mini layout-fixed">
  <div class="wrapper"></div>
  <!-- Preloader -->
  <div class="preloader flex-column justify-content-center align-items-center">
    <img class="animation__shake" src="dist/img/AdminLTELogo.png" alt="AdminLTELogo" height="60" width="60">
  </div>



  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-white navbar-light">
    <!-- Left navbar links -->
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" data-widget="pushmenu" href="#" role="button"><i class="fas fa-bars"></i></a>
      </li>
    </ul>

    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
      <!-- Notifications Dropdown Menu -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="far fa-bell"></i>
          <span class="badge badge-warning navbar-badge">15</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <span class="dropdown-item dropdown-header">15 Notifications</span>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-envelope mr-2"></i> 4 new messages
            <span class="float-right text-muted text-sm">3 mins</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-users mr-2"></i> 8 friend requests
            <span class="float-right text-muted text-sm">12 hours</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-file mr-2"></i> 3 new reports
            <span class="float-right text-muted text-sm">2 days</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item dropdown-footer">See All Notifications</a>
        </div>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <!-- <i class="far fa-comments"></i>-->
          <img src="img/person-circle.svg" alt="" width="37px">
          <!--<span class="badge badge-danger navbar-badge">3</span>-->
        </a>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->
  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-white-primary elevation-4">
    <!-- Brand Logo -->
    <a href="index3.html" class="brand-link">
      <img src="img/shop.svg" alt="AdminLTE Logo" classs="brand-image img-circle elevation-3" style="opacity: .8"
        height="50" width="50">
      <span class="brand-text font-weight-light">&nbsp;&nbsp;&nbsp;<b>ECONOMIZANDO</b></span>
    </a>
    <nav class="mt-2">
      <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
        <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
        <li class="nav-header">_______________________________</li>
        <li class="nav-item">
          <a href="consulta_produtos.html" class="nav-link">
            <img src="img/currency-dollar.svg" alt="">
            <p>Consultar Preço</p>
          </a>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">
            <img src="img/basket.svg" alt="">
            <p>
              Produtos
              <i class="right fas fa-angle-left"></i>
            </p>
          </a>
          <ul class="nav nav-treeview">
            <li class="nav-item">
              <a href="cadastro_produtos.html" class="nav-link">
                <i class="far nav-icon"></i>
                <img src="img/pencil.svg" alt="">
                <p>Cadastrar</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="lista_produtos.html" class="nav-link">
                <i class="far nav-icon"></i>
                <img src="img/list-ul.svg" alt="">
                <p>Lista de produtos</p>
              </a>
            </li>
          </ul>
        </li>
        <li class="nav-item">
          <a href="#" class="nav-link">
            <img src="img/gear.svg" alt="">
            <p>
              Painel Administrativo
              <i class="right fas fa-angle-left"></i>
            </p>
          </a>
          <ul class="nav nav-treeview">
            <li class="nav-item">
              <a href="cadastro_usuarios.html" class="nav-link">
                <i class="far nav-icon"></i>
                <img src="img/pencil.svg" alt="">
                <p>Novo Cadastro</p>
              </a>
            </li>
            <li class="nav-item">
              <a href="lista_cadastros.html" class="nav-link">
                <i class="far nav-icon"></i>
                <img src="img/list-ul.svg" alt="">
                <p>Lista de Cadastros</p>
              </a>
            </li>
          </ul>
        </li>
      </ul>
    </nav>
    <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->

  </aside>
  <div class="card card-primary">
    <div class="content-wrapper">
      <div class="card-header">
        <h3 class="card-title">CONSULTA DE PRODUTOS</h3>
      </div>
      <form id="consulta-produtos" class="form-group">
        <div class="card-body">
          <div class="form-group">
            <label for="descricao_produto">Nome do Produto:</label>
            <input class="form-control" type="text" id="descricao_produto" name="descricao_produto" />
            <label for="marca_produto">Marca do Produto:</label>
            <input type="text" name="marca_produto" id="marca_produto" class="form-control" />
            <label for="uf">Estado:</label>
            <select name="uf" id="uf" class="form-control">
              <option value="">Selecione...</option>
            </select>
            <!--seleção de uf do usuario-->
            <label for="id_cidade">Cidade:</label>
            <select name="id_cidade" id="id_cidade" class="form-control">
              <option value="">Selecione...</option>
            </select>
            <!-- <label for="id_usuariom">Mercado:</label>
      <select name="id_usuariom" id="id_usuariom" class="form-control">
        <option value="">Selecione...</option></select>-->
            <!-- <label for="preco_alto">Preço máximo desejado:</label>
        <input type="number" id="preco_alto" name="preco_alto"><br><br>
        <label for="observacao">Observação:</label>
        <input type="text" id="observacao" name="observacao"><br><br> -->
          </div>
          <br><input type="submit" id="send" class="btn btn-primary" value="Pesquisar" />
      </form>

      <br><br>
      <h3 class="card-title">LISTA DE PRODUTOS</h3><br>
      <table border="1" width="100%" class="table table-bordered table-hover">
        <thead>
          <th>Descrição do Produto</th>
          <th>Marca do Produto</th>
          <th>Nome do Mercado</th>
          <th>Preço do Produto</th>
          <th>Observação</th>
          <th>Peso do Produto</th>
          <th>Última Modificação</th>
        </thead>
        <tbody id="lista-produtos"></tbody>
      </table>
    </div>
  </div>
  </div>
  <div id="popupitem"></div>
  </div>
  <script>
    async function buscaMercados() {
      const response = await fetch(
        `http://localhost:4000/mercados?id_cidade=${document.getElementById("id_cidade").value
        }`
      );
      const data = await response.json();

      const select = document.getElementById("id_usuariom");

      data.forEach(function (data, indice) {
        const option = document.createElement("option");
        option.value = data.id;
        option.innerHTML = data.nome;
        select.appendChild(option);
      });


    }

    async function carregarUfs() {
      const select = document.getElementById("uf");
      const resposta = await fetch(
        "https://servicodados.ibge.gov.br/api/v1/localidades/estados"
      );
      const estados = await resposta.json();
      estados.forEach(function (estado) {
        const option = document.createElement("option");
        option.value = estado.sigla;
        option.innerHTML = estado.sigla;
        select.appendChild(option);
      });
    }
    carregarUfs();

    async function buscarCidades() {
      const uf = document.getElementById("uf").value;
      const resposta = await fetch(
        `https://servicodados.ibge.gov.br/api/v1/localidades/estados/${uf}/municipios`
      );
      const cidades = await resposta.json();
      const select = document.getElementById("id_cidade");
      select.innerHTML = "";
      cidades.forEach(function (cidade) {
        const option = document.createElement("option");
        option.value = cidade.id;
        option.innerHTML = cidade.nome;
        /*          
                  if (index == 0) {
                    option.selected = true;
                    
                  }  */
        select.appendChild(option);
      });
      verifica_cidade = Array.from(document.querySelectorAll('#id_cidade option:checked'));

      if (verifica_cidade.length > 0) {
        buscaMercados();
      }

    }
    document.getElementById("uf").addEventListener("change", buscarCidades);

    document
      .getElementById("id_cidade")
      .addEventListener("change", buscaMercados);

    function formatarData(data) {
      const dataObj = new Date(data);
      const dia = String(dataObj.getDate()).padStart(2, "0");
      const mes = String(dataObj.getMonth() + 1).padStart(2, "0");
      const ano = dataObj.getFullYear();
      return `${dia}/${mes}/${ano}`;
    }

    function closePopup() {
      const popup = document.querySelector('.popup');
      const overlay = document.querySelector('.overlay');

      if (popup && overlay) {
        popup.style.display = 'none';
        overlay.style.display = 'none';

        // Remova o popup e o overlay do DOM
        popup.parentNode.removeChild(popup);
        overlay.parentNode.removeChild(overlay);
      }
    }

    //inicio: consulta de produtos
    document
      .getElementById("consulta-produtos")
      .addEventListener("submit", async (event) => {
        event.preventDefault();

        const formData = new FormData(event.target);
        const queryParams = new URLSearchParams(formData).toString();

        try {
          const response = await fetch(
            `http://localhost:4000/produtos?${queryParams}`
          );
          const data = await response.json();
          const resultList = document.getElementById("lista-produtos");
          resultList.innerHTML = "";

          function openPopup(item) {
            console.log(item)
            var peso_formatado =
              item.peso_produto.toFixed(2).replace(".", ",") +
              item.unid_medida_produto;
            const productPopup = document.createElement("div");
            productPopup.className = "popup";
            productPopup.innerHTML = `
                    <span class="close" onclick="closePopup() ">X</span>
                    <h2>Informações do Produto</h2>
                    <p>Descrição: ${item.descricao_produto}</p>
                    <p>Marca: ${item.marca_produto}</p>
                    <p>Preço: R$${item.preco_produto
                .toFixed(2)
                .replace(".", ",")}</p>
                    <p>Observação: ${item.observacao_produto}</p>
                    <p>Peso: ${peso_formatado}</p>
                    <p>Data de Atualização: ${formatarData(item.updatedAt)}</p>
                `;


            document.body.appendChild(productPopup);

            // Exiba o popup
            productPopup.style.display = "block";

            // Exiba o overlay de fundo
            const overlay = document.createElement("div");
            overlay.className = "overlay";
            document.body.appendChild(overlay);
            overlay.addEventListener('click', closePopup);
          }

          data.forEach((item) => {
            const listItem = document.createElement("tr");
            var peso_formatado =
              item.peso_produto.toFixed(2).replace(".", ",") + ' ' +
              item.unid_medida_produto;
            listItem.innerHTML = `
                          <td style="text-align: left;">${item.descricao_produto
              }</td>
                          <td style="text-align: left;">${item.marca_produto
              }</td>
                          <td style="text-align: left;">${item.nome_mercado
              }</td>
                          <td style="text-align: right;">R$${item.preco_produto
                .toFixed(2)
                .replace(".", ",")}</td>
                          <td style="text-align: left;">${item.observacao_produto
              }</td>
                          <td style="text-align: right;">${peso_formatado}</td> 
                          <td style="text-align: center;">${formatarData(
                item.updatedAt
              )}</td> 
                          <td style="text-align: center;">
                            <button class="openPopupButton">Mostrar Produto</button>
                          </td>
                    `;

            resultList.appendChild(listItem);
            const openPopupButton =
              listItem.querySelector(".openPopupButton");
            openPopupButton.addEventListener("click", () => openPopup(item));
          });
        } catch (error) {
          console.error(error);
        }
      });
  </script>
  <!-- jQuery -->
  <script src="plugins/jquery/jquery.min.js"></script>
  <!-- jQuery UI 1.11.4 -->
  <script src="plugins/jquery-ui/jquery-ui.min.js"></script>
  <!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
  <script>
    $.widget.bridge('uibutton', $.ui.button)
  </script>
  <!-- Bootstrap 4 -->
  <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- ChartJS -->
  <script src="plugins/chart.js/Chart.min.js"></script>
  <!-- Sparkline -->
  <script src="plugins/sparklines/sparkline.js"></script>
  <!-- JQVMap -->
  <script src="plugins/jqvmap/jquery.vmap.min.js"></script>
  <script src="plugins/jqvmap/maps/jquery.vmap.usa.js"></script>
  <!-- jQuery Knob Chart -->
  <script src="plugins/jquery-knob/jquery.knob.min.js"></script>
  <!-- daterangepicker -->
  <script src="plugins/moment/moment.min.js"></script>
  <script src="plugins/daterangepicker/daterangepicker.js"></script>
  <!-- Tempusdominus Bootstrap 4 -->
  <script src="plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
  <!-- Summernote -->
  <script src="plugins/summernote/summernote-bs4.min.js"></script>
  <!-- overlayScrollbars -->
  <script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
  <!-- AdminLTE App -->
  <script src="dist/js/adminlte.js"></script>
  <!-- AdminLTE for demo purposes -->
  <script src="dist/js/demo.js"></script>
  <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
  <script src="dist/js/pages/dashboard.js"></script>
</body>

</html>